{%- extends "/html/base_template.html" %}
{%- block title %}ASPA {{ seasons[0].name }}{%- endblock %}
{%- block head %}
  {{ super() }}

  <script>
  {%- autoescape false %}
  var playerSummaries = {{ player_summaries }};
  {%- endautoescape %}

  function findHandicap(playerId) {
    for (var i in playerSummaries) {
      var playerSummary = playerSummaries[i];
      if (playerSummary.player.id == playerId) {
        return playerSummary.handicap;
      }
    }
    return 0;
  }

  function setHandicap(selectName, inputName) {
    var inputElement = document.getElementById(inputName);
    var selectElement = document.getElementById(selectName);
    if (!inputElement || !selectElement) {
      inputElement.value = "";
      return;
    }
    inputElement.value = findHandicap(selectElement.value);
  }

  $().ready(function() {
    $("#addPlayerForm").validate({
      rules: {
        season_select: "required",
        club_select: "required",
        winner_select: "required",
        loser_select: "required",
        winner_handicap: {
          required: true,
          number: true,
          range: [100, 1000]
        },
        loser_handicap: {
          required: true,
          number: true,
          range: [100, 1000]
        },
        winner_target: {
          required: true,
          number: true,
          range: [1, 150]
        },
        loser_target: {
          required: true,
          number: true,
          range: [1, 150]
        },
        winner_score: {
          required: true,
          number: true,
          range: [1, 150]
        },
        loser_score: {
          required: true,
          number: true,
          range: [1, 150]
        },
        winner_highrun: {
          number: true,
          range: [1, 1000]
        },
        loser_highrun: {
          number: true,
          range: [1, 1000]
        },
        todays_date: {
          required: true,
          dateISO: true
        }
      }
    });

  {%- if display_form %}
    $(function() { $( "#todays_date" ).datepicker({ dateFormat: "yy-mm-dd" }); });

    $('#season_select').prop('selectedIndex', {{ season_selectedIndex }})
    $('#club_select').prop('selectedIndex', {{ club_selectedIndex }})
    $('#winner_select').prop('selectedIndex', {{ winner_selectedIndex }})
    $('#loser_select').prop('selectedIndex', {{ loser_selectedIndex }})
  {%- endif %}
  });
  </script>
{%- endblock %}
{%- block content %}
  <h1>American Straight Pool Association</h1>

  {%- if display_form %}
  <h3>Add a match result</h3>
  <hr/>
  <form id="addMatchForm" action="/admin/addMatch/" method="post">
    <p>Date: <input name="todays_date" id="todays_date" value="{{ todays_date }}" size="10"></input></p>
    
    <p>Season: <select name="season_select" id="season_select" value=-1>
      {%- for season in seasons %}
      <option value="{{ season.id }}">{{ season.name }}</option>
      {%- endfor %}
      </select>
    </p>

    <p>Club: <select name="club_select" id="club_select" value=-1>
      {%- for club in clubs %}
      <option value="{{ club.id }}">{{ club.name }}</option>
      {%- endfor %}
      </select>
    </p>

  <table border>
    <tr>
      <td align="right">Winner:
        <select name="winner_select" id="winner_select" value=-1
            onchange='setHandicap("winner_select", "winner_handicap")'>
          {%- for player in players %}
          <option value="{{ player.id }}" {%- if player.id == winner.player_id %}selected{%- endif %}>
          {{ player.firstName }} {{ player.lastName }}
          </option>
          {%- endfor %}
        </select>
      </td>
      <td align="right">Loser:
        <select name="loser_select" id="loser_select"
            onchange='setHandicap("loser_select", "loser_handicap")'>
          {%- for player in players %}
          <option value="{{ player.id }}" {%- if player.id == loser.player_id %}selected{%- endif %}>
          {{ player.firstName }} {{ player.lastName }}
          </option>
          {%- endfor %}
        </select>
      </td>
    </tr>
    <tr>
      <td>Handicap: <input id="winner_handicap" name="winner_handicap" value="{{ winner.handicap }}" size="5"/></td>
      <td>Handicap: <input id="loser_handicap" name="loser_handicap" value="{{ loser.handicap }}" size="5"/></td>
    </tr>
    <tr>
        <td>Target: <input id="winner_target" name="winner_target" value="{{ winner.target }}" size="5"
          onchange='winner_score.value = this.value'/></td>
      <td>Target: <input id="loser_target" name="loser_target" value="{{ loser.target }}" size="5"/></td>
    </tr>
    <tr>
        <td>Score: <input id="winner_score" name="winner_score" value="{{ winner.score }}" size="5"/></td>
        <td>Score: <input id="loser_score" name="loser_score" value="{{ loser.score }}" size="5"/></td>
    </tr>
    <tr>
        <td>High Run: <input id="winner_highrun" name="winner_highrun" value="{{ winner.highrun }}" size="5"/></td>
        <td>High Run: <input id="loser_highrun" name="loser_highrun" value="{{ loser.highrun }}" size="5"/></td>
    </tr>
  </table>
  <p>
    <input type="button" value="Cancel" onclick="window.location.href='/admin/'"/>
    <input type="submit" value="Submit"/>
  </p>
  </form>
  {%- elif error_messages %}
  <h3>
    <font color=red>Unable to add match result:
    <ul>
    {%- for message in error_messages %}
    <li>{{ message }}</li>
    {%- endfor %}
    </ul>
    </font>
  </h3>
  {%- else %}
  <h3>Successfully added match result: {{ winner.firstName }} beat {{ loser.firstName }}</h3>
  <p><input type="button" value="Done" onclick="window.location.href='/admin/'">
  {%- endif %}
  </div>
{%- endblock %}
