{%- extends "/html/base_template.html" %}
{%- block title %}ASPA {{ season.name }}{%- endblock %}
{%- block head %}
  {{ super() }}

  <script>
  {%- autoescape false %}
  var playerSummaries = {{ player_summaries }};
  var playerA_selectedIndex = {{ playerA_selectedIndex}};
  var playerB_selectedIndex = {{ playerB_selectedIndex}};

  var ViewModel = {
    races: ko.observableArray([]),
  };
  {%- endautoescape %}

  function findHandicap(playerId) {
    for (var i in playerSummaries) {
      var playerSummary = playerSummaries[i];
      if (playerSummary.player.id == playerId) {
        return playerSummary.handicap;
      }
    }
    return 0;
  }

  function setHandicap(selectName, inputName) {
    var inputElement = document.getElementById(inputName);
    var selectElement = document.getElementById(selectName);
    if (!inputElement || !selectElement) {
      inputElement.value = "";
      return;
    }
    inputElement.value = findHandicap(selectElement.value);
    generateRaces();
  }

  function generateRaces() {
    var handicapA = document.getElementById("playerA_handicap").value;
    var handicapB = document.getElementById("playerB_handicap").value;
    var races = [];
    if (handicapA >= 100 && handicapA < 1000) {
      if (handicapB >= 100 && handicapB < 1000) {
        var delta = Math.abs(handicapA - handicapB);
        for (var x=50; x<=140; x+=10) {
          var lower = Math.round(x / Math.pow(2, delta/100.0) / 5) * 5;
          var playerA = '';
          var playerB = '';
          if (lower > 5) {
            if (handicapA > handicapB) {
              playerA = x;
              playerB = lower;
            } else {
              playerA = lower;
              playerB = x;
            }
          }
          races.push({ 'playerA': playerA, 'playerB': playerB, });
        }
      }
    }

    ViewModel.races(races);
  }

  $().ready(function() {
    $("#addPlayerForm").validate({
      rules: {
        club_select: "required",
        playerA_select: "required",
        playerB_select: "required",
        playerA_handicap: {
          required: true,
          numeric: true,
        },
        playerB_handicap: {
          required: true,
          numeric: true,
        },
      }
    });

    $('#playerA_select').prop('selectedIndex', -1)
    $('#playerB_select').prop('selectedIndex', -1)

    ko.applyBindings(ViewModel);
  });
  </script>
{%- endblock %}
{%- block content %}
  <h1>American Straight Pool Association</h1>

  <h3>Suggested Race:</h3>
  <hr/>
  <table border>
    <tr>
      <td align="right">Player 1:
        <select name="playerA_select" id="playerA_select" value=-1
            onchange='setHandicap("playerA_select", "playerA_handicap")'>
          {%- for player in players %}
          <option value="{{ player.id }}">
          {{ player.firstName }} {{ player.lastName }}
          </option>
          {%- endfor %}
        </select>
      </td>
      <td align="right">Player 2:
        <select name="playerB_select" id="playerB_select"
            onchange='setHandicap("playerB_select", "playerB_handicap")'>
          {%- for player in players %}
          <option value="{{ player.id }}">
          {{ player.firstName }} {{ player.lastName }}
          </option>
          {%- endfor %}
        </select>
      </td>
    </tr>
    <tr>
        <td>Handicap: <input id="playerA_handicap" name="playerA_handicap" size="5" onchange="generateRaces()"/></td>
        <td>Handicap: <input id="playerB_handicap" name="playerB_handicap" size="5" onchange="generateRaces()"/></td>
    </tr>
  <!-- ko foreach: races -->
      <tr>
          <td><span data-bind="text: playerA"></span></td>
          <td><span data-bind="text: playerB"></span></td>
      </tr>
  <!-- /ko -->
  </table>
  <p>
    <input type="button" value="Done" onclick="window.location.href='/admin/'"/>
  </p>
  </div>
{%- endblock %}
