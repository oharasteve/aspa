
{%- extends "/html/admin_template.html" %}
{%- block title %}ASPA {{ seasons[0].name }}{%- endblock %}
{%- block head %}
  {{ super() }}

<style>
.registered { background-color: lightblue }
.recommend { background-color: lightgreen }
</style>
  <script>
  {%- autoescape false %}

  var ViewModel = new function() {
    var self = this;
    this.players =  ko.observableArray({{players}});
    this.playerA_selected = ko.observable();
    this.playerB_selected = ko.observable();
    this.playerA_handicap = ko.computed(function() {
            return this.playerA_selected() ? this.playerA_selected().handicap : '';
            }, this);
    this.playerB_handicap = ko.computed(function() {
            return this.playerB_selected() ? this.playerB_selected().handicap : '';
            }, this);
    this.races = ko.observableArray([]);
    this.generateRaces = function() {
        var generated_races = [];
        // Admin might have edited the text box to quickly check races between
        // arbitrary handicaps. So use value of input instead of viewmodel.
        var handicapA = parseInt($('#playerA_handicap').val(), 10);
        var handicapB = parseInt($('#playerB_handicap').val(), 10);
        if (handicapA >= 100 && handicapA < 1000) {
            if (handicapB >= 100 && handicapB < 1000) {
                var delta = Math.abs(handicapA - handicapB);
                for (var x=50; x<=140; x+=10) {
                    var lower = Math.round(x / Math.pow(2, delta/100.0) / 5) * 5;
                    var playerA = '';
                    var playerB = '';
                    var urlParam = '';
                    if (lower > 5) {
                        if (handicapA > handicapB) {
                            playerA = x;
                            playerB = lower;
                        } else {
                            playerA = lower;
                            playerB = x;
                        }
                    }
                    var a_name = "Player A";
                    var b_name = "Player B";
                    if (this.playerA_selected() != undefined) {
                        a_name = this.playerA_selected().fullName;
                    }
                    if (this.playerB_selected() != undefined) {
                        b_name = this.playerB_selected().fullName;
                    }
                    urlParam = "/apps/match.html"+
                               "?p1_name="+a_name+
                               "&p2_name="+b_name+
                               "&p1_target="+playerA+
                               "&p2_target="+playerB;

                    recommend = ""
                    if ((130 < (playerA + playerB)) && ((playerA + playerB) < 150)) {
                          recommend = 'recommend'
                    }
                    generated_races.push({ 'playerA': playerA, 'playerB': playerB,
                      'urlParam': urlParam, 'recommend': recommend, 'register': (this.playerA_selected() && this.playerB_selected())
                    });
                }
            }
        }
        self.races(generated_races);
    };
  };

function register_match(event) {
    console.log("in update");
    var parent = event.target.parentElement.parentElement;
    parent.className ='registered';

    //var url = "https://reqbin.com/echo/post/form";
    var url="/{{club.key.id()}}/admin/startMatch/";

    var xhr = new XMLHttpRequest();
    xhr.open("POST", url);

    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

    xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
        console.log(xhr.status);
        console.log(xhr.responseText);
    }};

    var fields = Array.from(parent.getElementsByClassName('field'));
    var today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1; //January is 0!
    var yyyy = today.getFullYear();
    if(dd<10){dd='0'+dd};
    if(mm<10){mm='0'+mm};
    today = yyyy+'-'+mm+'-'+dd;

    var data = "season_select={{ seasons[0].id }}&match_date="+today;
    data += "&playera_select="+ViewModel.playerA_selected().playerId;
    data += "&playerb_select="+ViewModel.playerB_selected().playerId;
    data += "&playera_handicap="+document.getElementById('playerA_handicap').value;
    data += "&playerb_handicap="+document.getElementById('playerB_handicap').value;
    fields.forEach(field => {data += "&"+field.id+"="+(field.innerText || field.value)});

    console.log(data);
    xhr.send(data);

    var buttons = parent.parentElement.querySelectorAll('button');
    buttons.forEach(function (e) { e.remove(); });
}
  {%- endautoescape %}

  $().ready(function() {
    $("#addPlayerForm").validate({
      rules: {
        playerA_select: "required",
        playerB_select: "required",
        playerA_handicap: {
          required: true,
          numeric: true,
        },
        playerB_handicap: {
          required: true,
          numeric: true,
        },
      }
    });

    ko.applyBindings(ViewModel);
  });
  </script>
{%- endblock %}
{%- block admin_content %}
  <h3>Suggested Race:</h3>
  <hr/>

  <form class="form-horizontal" role="form">
    <div class="form-group">
      <label for="playerA_select" class="col-sm-2 control-label">Player 1</label>
      <div class="col-sm-3">
        <select name="playerA_select" id="playerA_select" class="form-control" value="-1"
            data-bind="options: players,
                       optionsText: 'fullName',
                       optionsCaption: 'Choose ...',
                       value: playerA_selected,
                       event: { change: generateRaces }"
                       ></select>
      </div>
      <label for="playerB_select" class="col-sm-1 control-label">Player 2</label>
      <div class="col-sm-3">
        <select name="playerB_select" id="playerB_select" class="form-control" value="-1"
            data-bind="options: players,
                       optionsText: 'fullName',
                       optionsCaption: 'Choose ...',
                       value: playerB_selected,
                       event: { change: generateRaces }"
            ></select>
      </div>
    </div>
    <div class="form-group">
      <label for="playerA_handicap" class="col-sm-2 control-label">Handicap</label>
      <div class="col-sm-3">
        <input id="playerA_handicap" name="playerA_handicap" class="form-control"
            data-bind="value: playerA_handicap"
            onchange="ViewModel.generateRaces()" />
      </div>
      <label for="playerB_handicap" class="col-sm-1 control-label">Handicap</label>
      <div class="col-sm-3">
        <input id="playerB_handicap" name="playerB_handicap" class="form-control"
            data-bind="value: playerB_handicap"
            onchange="ViewModel.generateRaces()" />
      </div>
    </div>
  </form>

  <div class="row">
    <div class="col-sm-offset-2 col-sm-7">
      <table class="table table-bordered table-condensed table-hover">
        <tbody>
          <!-- ko foreach: races -->
          <tr data-bind="css: recommend">
            <td><a data-bind="attr: {href: urlParam}" target="_blank" rel="noopener noreferrer">scoreboard</a>
                <button data-bind="if: register" onclick="register_match(event)">register</button></td>
            <td><span id="playera_target" class="field" data-bind="text: playerA"></span></td>
            <td><span id="playerb_target" class="field" data-bind="text: playerB"></span></td>
          </tr>
          <!-- /ko -->
        </tbody>
      </table>
    </div>
  </div>
  <div style="display: none" id="qr"></div>
{%- endblock %}
