{%- extends "/html/base_template.html" %}
{%- block title %}ASPA {{ season.name }}{%- endblock %}
{%- block head %}
  {{ super() }}
  <script>
  {%- autoescape false %}
  var highRuns = {{ highRuns }};
  {%- endautoescape %}

  function getHighRunTarget(highruns, handicap) {
    if (handicap < 100 || handicap >= 1000) {
        return 0;
    }
    for (var i = 0; i < highruns.length; i++) {
      if (handicap < highruns[i].handicap || i == highruns.length - 1) {
          break;
      }
    }
    var prev_handicap = 0;
    var prev_target = 0;
    if (i > 0) {
        prev_handicap = highruns[i-1].handicap;
        prev_target = highruns[i-1].target;
    }
    var scale = (highruns[i].handicap - prev_handicap) / (highruns[i].target - prev_target);
    return Math.round(prev_target + (handicap - prev_handicap) / scale);
  }

  function setHighRunTarget(handicapName, highRunTargetName) {
      var handicapElement = document.getElementById(handicapName);
      var highRunElement = document.getElementById(highRunTargetName);
      highRunElement.value = getHighRunTarget(highRuns, handicapElement.value);
  }

  $().ready(function() {
    $("#addPlayerForm").validate({
      rules: {
        code: "required",
        firstName: "required",
        lastName: "required",
        handicap: {
          required: true,
          number: true,
          range: [100, 1000]
        },
        highRunTarget: {
          required: true,
          range: [0, 1000]
        },
        phone: {
          phoneUS: true
        },
        email: {
          email: true
        }
      }
    });
  });
  </script>
{%- endblock %}
{%- block content %}
  <h1>American Straight Pool Association</h1>

  {%- if display_form %}
  <h3>Add a New Player</h3>
  <hr/>
  <form id="addPlayerForm" action="/admin/addPlayer/" method="post">
  <table>
    <tr>
      <td align="right">Code:</td>
      <td align="left"><input name="code" id="code" size="5" type="text" value="{{ player.code }}"/></td>
    </tr>
    <tr>
      <td align="right">First Name:</td>
      <td align="left"><input name="firstName" id="firstName" type="text" value="{{ player.firstName }}"/></td>
    </tr>
    <tr>
      <td align="right">Last Name:</td>
      <td align="left"><input name="lastName" id="lastName" type="text" value="{{ player.lastName }}"/></td>
    </tr>
    <tr>
      <td align="right">Handicap:</td>
      <td align="left"><input size="5" onchange='setHighRunTarget("handicap","highRunTarget")'
          name="handicap" id="handicap" type="text" value="{{ player.handicap }}"/></td>
    </tr>
    <tr>
      <td align="right">High Run Target:</td>
      <td align="left"><input size="5" name="highRunTarget" id="highRunTarget"
          type="text" value="{{ player.highRunTarget }}"/></td>
    </tr>
    <tr>
      <td align="right">Phone:</td>
      <td align="left"><input name="phone" id="phone" type="text" value="{{ player.phone }}"/></td>
    </tr>
    <tr>
      <td align="right">Email:</td>
      <td align="left"><input name="email" id="email" type="text" value="{{ player.email }}"/></td>
    </tr>
  </table>
  <p>
    <input type="button" value="Cancel" onclick="window.location.href='/admin/'"/>
    <input type="submit" value="Submit"/>
  </p>
  </form>
  {%- elif error_messages %}
  <h3>
    <font color=red>Unable to add new player:
    <ul>
    {%- for message in error_messages %}
    <li>{{ message }}</li>
    {%- endfor %}
    </ul>
    </font>
  </h3>
  {%- else %}
  <h3>Successfully added new player: {{ player.firstName }} {{ player.lastName }} ({{ player.code }})</h3>
  <p><input type="button" value="Done" onclick="window.location.href='/admin/'">
  {%- endif %}
  </div>
{%- endblock %}
